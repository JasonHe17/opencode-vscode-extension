(()=>{var k=acquireVsCodeApi();var m=document.getElementById("messages"),d=document.getElementById("messageInput"),M=document.getElementById("sendButton"),D=document.getElementById("attachButton"),p=document.getElementById("fileSuggestions"),E=document.getElementById("agentSelect"),v=document.getElementById("modelSelect"),T=[],f=null,S=null;E.addEventListener("change",()=>{b({type:"changeAgent",agent:E.value})});v.addEventListener("change",()=>{b({type:"changeModel",model:v.value})});function b(t){k.postMessage(t)}function H(t){let e=document.createElement("div");e.className=`message ${t.role}`,e.setAttribute("data-message-id",t.id);let n=document.createElement("div");n.className="message-role",n.textContent=t.role==="user"?"You":"OpenCode",e.appendChild(n);let l=document.createElement("div");l.className="message-content",e.appendChild(l),t.parts.forEach(s=>{if(s.type==="text"){let i=w(C(s));i.setAttribute("data-part-id",s.id||""),i.className="message-text",l.appendChild(i)}else if(s.type==="tool"){console.log("[renderMessage] Rendering tool part:",s);let i=B(s.content||s);i.setAttribute("data-part-id",s.id||""),l.appendChild(i)}else s.type==="reasoning"?q(C(s),l).setAttribute("data-part-id",s.id||""):console.log("[renderMessage] Unknown part type:",s.type,s)}),m.appendChild(e),m.scrollTop=m.scrollHeight}function w(t){let e=document.createElement("div");return e.style.whiteSpace="pre-wrap",e.textContent=t,e}function C(t){var e;return t!=null&&t.content&&typeof t.content=="string"?t.content:t!=null&&t.text&&typeof t.text=="string"?t.text:(e=t==null?void 0:t.content)!=null&&e.html&&typeof t.content.html=="string"?t.content.html:t!=null&&t.content?String(t.content):""}function q(t,e){let n=document.createElement("div");n.className="reasoning-container",n.setAttribute("data-collapsed","true");let l=document.createElement("div");l.className="reasoning-label",l.innerHTML='<span class="reasoning-icon">\u{1F9E0}</span> Thinking... <span class="collapse-icon">\u25BC</span>',n.appendChild(l);let s=document.createElement("div");return s.className="reasoning-content",t&&typeof t=="object"&&t.html?s.innerHTML=t.html:typeof t=="string"?s.textContent=t:typeof t=="number"&&(s.textContent=String(t)),n.appendChild(s),l.addEventListener("click",i=>{n.getAttribute("data-collapsed")==="true"?n.setAttribute("data-collapsed","false"):n.setAttribute("data-collapsed","true"),y(n),i.stopPropagation()}),e.appendChild(n),n}function y(t){let e=t.querySelector(".collapse-icon");if(e){let n=t.getAttribute("data-collapsed")==="true";e.textContent=n?"\u25BC":"\u25B2"}}function A(t,e,n){if(!e)return;let l=T.find(o=>o.id===t);if(!l)return;let s=m.querySelector(`[data-message-id="${t}"]`);if(!s)return;let i=s.querySelector(".message-content");if(!i)return;let c=l.parts.find(o=>o.id===e||o.content&&o.content.id===e);if(c){if(Object.assign(c,n),n.type==="reasoning"){let o=i.querySelector(`.reasoning-container[data-part-id="${e}"]`);if(o){let a=o.querySelector(".reasoning-content");a&&(n.content&&typeof n.content=="object"&&n.content.html?a.innerHTML=n.content.html:typeof n.content=="string"?a.textContent=n.content:typeof n.text=="string"&&(a.textContent=n.text),o.scrollTop=o.scrollHeight)}}else if(n.type==="text"){let o=i.querySelector(`.message-text[data-part-id="${e}"]`);o&&(o.textContent=C(n))}}else if(l.parts.push(n),n.type==="reasoning"){let o=document.createElement("div");o.className="reasoning-container",o.setAttribute("data-part-id",e);let a=document.createElement("div");a.className="reasoning-label",a.innerHTML='<span class="reasoning-icon">\u{1F9E0}</span> Thinking... <span class="collapse-icon">\u25BC</span>',o.appendChild(a);let u=document.createElement("div");u.className="reasoning-content",n.content&&typeof n.content=="object"&&n.content.html?u.innerHTML=n.content.html:typeof n.content=="string"?u.textContent=n.content:typeof n.text=="string"&&(u.textContent=n.text),o.appendChild(u),a.addEventListener("click",x=>{o.getAttribute("data-collapsed")==="true"?o.setAttribute("data-collapsed","false"):o.setAttribute("data-collapsed","true"),y(o),x.stopPropagation()}),i.appendChild(o)}else if(n.type==="tool"&&n.content){i.querySelectorAll(".reasoning-container").forEach(a=>a.setAttribute("data-collapsed","true")),i.querySelectorAll(".reasoning-container").forEach(a=>y(a));let o=document.createElement("div");o.innerHTML=$(n.content),i.appendChild(o)}else if(n.type==="text"){i.querySelectorAll(".reasoning-container").forEach(a=>a.setAttribute("data-collapsed","true")),i.querySelectorAll(".reasoning-container").forEach(a=>y(a));let o=w(C(n));o.setAttribute("data-part-id",e),o.className="message-text",i.appendChild(o)}m.scrollTop=m.scrollHeight}function B(t){let e=document.createElement("div");try{let n=t.html||$(t);e.innerHTML=n}catch(n){console.error("[renderToolExecution] Error rendering tool:",n,t),e.innerHTML=`<div class="tool-execution tool-error">
      <div class="tool-header">
        <span class="tool-icon">\u26A0\uFE0F</span>
        <span class="tool-name">Error rendering tool</span>
      </div>
      <pre class="tool-output">${g(String(t)||"Unknown error")}</pre>
    </div>`}return e}function $(t){var L;console.log("[constructToolHtml] Input content:",JSON.stringify(t,null,2));let e=t.state||t,n=t.tool||t.toolName||((L=t.toolData)==null?void 0:L.name)||"Unknown Tool",l=(e==null?void 0:e.status)||"pending",s=(e==null?void 0:e.title)||t.title||"",i=(e==null?void 0:e.output)||t.output||"",c=(e==null?void 0:e.error)||t.error||"",o=(e==null?void 0:e.input)||t.input||{},a={pending:"\u23F3",running:"\u{1F504}",completed:"\u2713",error:"\u2717"},u=O(n),x=a[l]||"\u23F3",r=`
    <div class="tool-execution" data-state="${l}">
      <div class="tool-header">
        <span class="tool-icon">${u}</span>
        <span class="tool-name">${g(n)}</span>
        <span class="tool-state">${x}</span>
      </div>
  `;s&&(r+=`<div class="tool-title">${g(s)}</div>`);let h=n==="bash"&&(o==null?void 0:o.command)||(o==null?void 0:o.command)||(o==null?void 0:o.description)||(o==null?void 0:o.location);return h&&(r+=`
      <div class="tool-content">
        <div class="tool-command-section">
          <div class="tool-command-label">Command</div>
          <pre class="tool-command">${g(o.command||o.description||o.location||"")}</pre>
        </div>
    `),l==="error"&&c?h?r+=`
        <div class="tool-output-section">
          <div class="tool-output-label">Error</div>
          <pre class="tool-output tool-error">${g(c)}</pre>
        </div>
      `:r+=`
        <div class="tool-error">
          <pre>${g(c)}</pre>
        </div>
      `:i?i.length>500||i.split(`
`).length>20?r+=`
        <div class="tool-output-section" data-collapsed="true">
          <div class="output-toggle" onclick="toggleToolSection(this)">
            <span class="toggle-icon">\u25B6</span>
            <span class="tool-output-label">Output</span>
          </div>
          <pre class="tool-output">${g(i)}</pre>
        </div>
      `:r+=`
        <div class="tool-output-section">
          <div class="tool-output-label">Output</div>
          <pre class="tool-output">${g(i)}</pre>
        </div>
      `:l==="pending"?h?r+=`
        <div class="tool-output-section">
          <div class="tool-output-label">Output</div>
          <div class="tool-pending">Waiting for execution...</div>
        </div>
      `:r+='<div class="tool-pending">Waiting for execution...</div>':l==="running"&&(h?r+=`
        <div class="tool-output-section">
          <div class="tool-output-label">Output</div>
          <div class="tool-running">Executing...</div>
        </div>
      `:r+='<div class="tool-running">Executing...</div>'),h&&(r+="</div>"),r+="</div>",r}function O(t){let e={bash:"\u{1F4BB}",read:"\u{1F4C4}",write:"\u{1F4DD}",edit:"\u270F\uFE0F",glob:"\u{1F50D}",grep:"\u{1F50E}",webfetch:"\u{1F310}",websearch:"\u{1F50D}",codesearch:"\u{1F50D}",task:"\u{1F527}",question:"\u2753",default:"\u{1F527}"};return e[t]||e.default}function g(t){let e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,n=>e[n])}window.toggleToolSection=function(t){let e=t.parentElement;if(e){let n=e.getAttribute("data-collapsed")==="true";console.log("[toggleToolSection] Current state:",n,"section:",e.className),n?e.removeAttribute("data-collapsed"):e.setAttribute("data-collapsed","true");let l=e.getAttribute("data-collapsed")==="true";console.log("[toggleToolSection] New state:",l);let s=t.querySelector(".toggle-icon");s&&(s.textContent=n?"\u25BC":"\u25B6")}};window.toggleToolOutput=function(t){let e=t.parentElement;e&&e.toggleAttribute("data-collapsed")};window.addEventListener("message",t=>{var n;let e=t.data;switch(console.log("Webview received message:",e.type,e),e.type){case"init":f=e.sessionId||null,S=e.sessionTitle||"New Session";let l=document.getElementById("sessionTitle");l&&(l.textContent=S),T=e.messages||[],m.innerHTML="",T.forEach(H);break;case"message":if(e.sessionId&&f&&e.sessionId!==f)break;H(e),T.push(e);break;case"messagePart":if(e.sessionId&&f&&e.sessionId!==f)break;A(e.messageId,e.partId||((n=e.part)==null?void 0:n.id),e.part);break;case"toolUpdate":if(e.sessionId&&f&&e.sessionId!==f)break;e.toolId&&e.updates&&A(e.messageId,e.toolId,{id:e.toolId,type:"tool",content:e.updates});break;case"sessionIdle":m.querySelectorAll(".reasoning-container").forEach(s=>{s.setAttribute("data-collapsed","true"),y(s)});break;case"fileSuggestions":R(e.files||e.suggestions||[]);break;case"insertText":I(e.text);break;case"clearSuggestions":p.hidden=!0;break;case"serverStatus":P(e.agents||[],e.models||[]);break}});function P(t,e){console.log("Updating selectors with models:",e);let n=E.value;E.innerHTML="",t.forEach(i=>{let c=document.createElement("option");c.value=i,c.textContent=i,i===n&&(c.selected=!0),E.appendChild(c)});let l=v.value;v.innerHTML="";let s=document.createElement("option");s.value="",s.textContent="Default Model",v.appendChild(s),e&&e.length>0?e.forEach(i=>{let c=document.createElement("optgroup");c.label=i.providerID,i.models.forEach(o=>{let a=document.createElement("option"),u=`${i.providerID}/${o}`;a.value=u,a.textContent=o,u===l&&(a.selected=!0),c.appendChild(a)}),v.appendChild(c)}):console.warn("No models received from server")}setTimeout(()=>{console.log("Sending init request..."),k.postMessage({type:"init"})},100);function R(t){if(p.innerHTML="",t.length===0){p.hidden=!0;return}t.forEach(e=>{let n=document.createElement("div");n.className="file-suggestion",n.innerHTML=`
      <span class="file-suggestion-icon">\u{1F4C4}</span>
      <span class="file-suggestion-path">${g(e.path)}</span>
      ${e.lineRange?`<span class="file-suggestion-range">${e.lineRange}</span>`:""}
    `,n.addEventListener("click",()=>{I(`@${e.path}${e.lineRange||""} `),p.hidden=!0}),p.appendChild(n)}),p.hidden=!1}function I(t){let e=d.selectionStart,n=d.selectionEnd,l=d.value.substring(0,e),s=d.value.substring(n);d.value=l+t+s,d.selectionStart=d.selectionEnd=e+t.length,d.focus()}M.addEventListener("click",N);D.addEventListener("click",()=>{b({type:"attachFile"})});d.addEventListener("keydown",t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),N())});function N(){let t=d.value.trim();t&&(b({type:"sendMessage",text:t}),d.value="",M.disabled=!0,setTimeout(()=>{M.disabled=!1},500))}d.addEventListener("input",t=>{let e=t.target.value,n=d.selectionStart,s=e.substring(0,n).match(/@([^\s]*)$/);if(s){let i=s[1];b({type:"requestFileSuggestions",searchTerm:i})}else p.hidden=!0});document.addEventListener("click",t=>{p.contains(t.target)||(p.hidden=!0)});})();
